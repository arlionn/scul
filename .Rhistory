geom_line(color = "#ffab10", alpha = 1, size = .5) +
theme_classic() +
geom_vline(xintercept = as.numeric(as.Date("2012-11-03")), linetype = "dashed", size = 1, color = "grey37") +
geom_vline(xintercept = as.numeric(as.Date("2014-01-01")), linetype = "dashed", size = 1, color = "grey37") +    labs(
title = "Beer",
x = "",
y = ""
) +
theme(
axis.text = element_text(size = 17),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
ylim(-.32, .32)
difference_hard_liquor <-  ggplot(data = temp_beer, aes(x = time, y = actual - scul)) +
geom_hline(yintercept = 0, linetype = "solid", size = 1, color = "black") +
geom_line(color = "black", alpha = 1, size = .75) +
geom_line(color = "#4dac26", alpha = 1, size = .5) +
theme_classic() +
geom_vline(xintercept = as.numeric(as.Date("2012-11-03")), linetype = "dashed", size = 1, color = "grey37") +
geom_vline(xintercept = as.numeric(as.Date("2014-01-01")), linetype = "dashed", size = 1, color = "grey37") +    labs(
title = "Hard liquor",
x = "Time",
y = ""
) +
theme(
axis.text = element_text(size = 17),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
ylim(-.32, .32)
difference_wine<-  ggplot(data = temp_wine, aes(x = time, y = actual - scul)) +
geom_hline(yintercept = 0, linetype = "solid", size = 1, color = "black") +
geom_line(color = "black", alpha = 1, size = .75) +
geom_line(color = "red", alpha = 1, size = .5) +
theme_classic() +
geom_vline(xintercept = as.numeric(as.Date("2012-11-03")), linetype = "dashed", size = 1, color = "grey37") +
geom_vline(xintercept = as.numeric(as.Date("2014-01-01")), linetype = "dashed", size = 1, color = "grey37") +
labs(
title = "Wine",
x = "",
y = ""
) +
theme(
axis.text = element_text(size = 17),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
ylim(-.32, .32)
library(cowplot)
scul_v_actual_plot_left <-  plot_grid(
NULL,
time_series_pain,
time_series_beer,
time_series_wine,
time_series_hard_liquor,
ncol = 1,
align = 'v',
rel_heights = c(.15,1,1,1,1),
labels = c('A. Actual time series (thin-black) v scul prediction (wide-color)'),
label_fontface = "plain",
hjust = -.1
)
scul_v_actual_plot_right <-  plot_grid(
NULL,
difference_pain,
difference_beer,
difference_wine,
difference_hard_liquor,
ncol = 1,
align = 'v',
rel_heights = c(.15,1,1,1,1),
labels = c('B. Difference between actual data and scul prediction'),
label_fontface = "plain",
hjust = -.1
)
scul_v_actual_plot_right
scul_v_actual_plot <-  plot_grid(
scul_v_actual_plot_left, scul_v_actual_plot_right,
ncol = 2,
rel_heights = c(1,1),
align = 'v'
)
# scul_v_actual_plot <-  plot_grid(
#     time_series_pain, difference_pain,
#     time_series_beer, difference_beer,
#     time_series_wine, difference_wine,
#     time_series_hard_liquor, difference_hard_liquor,
#     ncol = 2,
#     rel_heights = c(1,1),
#     align = 'v',
#     labels = c('A. Time Series', 'B. Difference'),
#     label_x = .2,
#     label_y = -.1
# )
scul_v_actual_plot
ggsave("~/Documents/GitHub/scul_work/vignettes/time_series_actual_v_scul.png",
plot = scul_v_actual_plot,
dpi = 300,
width = 15,
height = 10,
units = "in")
smoke_plot <- ggplot(data = data_to_plot_long, aes(x = time, y = value)) +
geom_line(aes(group = group), alpha = .025, size = .5) +
geom_line(data = temp_hard_liquor, aes(x = time, y = std_diff), alpha = 1, size = 1., color = "black") +
geom_line(data = temp_hard_liquor, aes(x = time, y = std_diff), alpha = 1, size = 0.75, color = "#4dac26") +
theme_classic() +
geom_segment(
aes(
x = (as.Date("2012-11-03")),
xend = (as.Date("2012-11-03")),
y = -5,
yend = 4.75),
linetype = "dashed",
size = 1,
color = "grey37"
) +
geom_segment(
aes(
x = (as.Date("2014-01-01")),
xend = (as.Date("2014-01-01")),
y = -5,
yend = 4.75),
linetype = "dashed",
size = 1,
color = "grey37"
)  +
labs(
title = "Standardized difference for hard liquor compared to standardized\n difference for each placebo donor product",
x = "Time",
y = "Difference between actual data and scul prediction\n in pre-treatment standard deviations for each product"
) +
theme(
axis.text = element_text(size = 18),
axis.title.y = element_text(size = 12),
axis.title.x = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
ylim(-5, 5)  +
annotate("text", x = as.Date("2012-11-03"), y = 5, label = "Possesion legal", size = 4, hjust = 0.75) +
annotate("text", x = as.Date("2014-01-01"), y = 5, label = "Selling legal", size = 4, hjust = 0.25)
smoke_plot
ggsave("~/Documents/GitHub/scul_work/vignettes/smoke_plot.png",
plot = smoke_plot,
dpi = 600,
width = 9,
height = 6,
units = "in")
# Note: 12 products not shown because the difference exceeds 5 standard deviations in the post-period.
#THese are included in the p=value calculation
##########################################################################################################
#  Clear memory
rm(list = ls())
# Set seed
set.seed(1234)
# Load libraries
library(tidyverse)
library(haven)
library(scul)
library(reshape2)
#########################################################################################################
#  Import data
AllYData <- read_dta("~/Documents/GitHub/scul_writing_and_code/data_for_analysis/qty_y_data_for_scul.dta")
AllXData <- read_dta("~/Documents/GitHub/scul_writing_and_code/data_for_analysis/qty_x_data_for_scul.dta")
#########################################################################################################
# Batch process all potential y's
processed.AllYData <- Preprocess(AllYData)
TreatmentBeginsAt<-357
PostPeriodLength <- nrow(processed.AllYData)-TreatmentBeginsAt+1
PrePeriodLength <- TreatmentBeginsAt-1
NumberInitialTimePeriods <-165
processed.AllYData <- PreprocessSubset(processed.AllYData,
TreatmentBeginsAt ,
NumberInitialTimePeriods,
PostPeriodLength,
PrePeriodLength)
#########################################################################################################
#  Initialize empty storage matrices
Results.y<-data.frame(matrix(ncol=ncol(processed.AllYData),nrow=nrow(processed.AllYData)))
Results.y.StandardizedDiff<-data.frame(matrix(ncol=ncol(processed.AllYData),nrow=nrow(processed.AllYData)))
Results.y.CohensD<-data.frame(matrix(ncol=ncol(processed.AllYData),nrow=1))
Results.y.ConvexHull<-data.frame(matrix(ncol=ncol(processed.AllYData),nrow=1))
#########################################################################################################
# Clear any prior data
rm(list = ls(pattern = "SCUL"))
rm(list = ls(pattern = "temp"))
#########################################################################################################
# Setup for SCUL
temp.time <-AllXData[,1]
temp.x <-AllXData[,-1]
temp.y <- data.frame(processed.AllYData[,2])
SCUL.input <- OrganizeDataAndSetup (
time = temp.time,
y = temp.y,
TreatmentBeginsAt = 357,
x.DonorPool = temp.x,
CohensDThreshold=0.25,
NumberInitialTimePeriods = 165,
x.PlaceboPool=temp.x,
OutputFilePath="~/Documents/GitHub/scul_writing_and_code/scul_weekly_output/"
)
##########################################################################################################
# Set output file path
OutputFilePath <- "~/Documents/GitHub/scul_writing_and_code/scul_weekly_output/"
CohensDThreshold <- .25
########################################################################################################
# Import data from a prior run so I don't have to rerun this each time
nullFilePath=paste(OutputFilePath,"qty_null_dist.dta",sep='')
placebo.distribution.full<-data.frame(read_dta(nullFilePath))
nullFilePath=paste(OutputFilePath,"qty_null_dist_cohen_d.dta",sep='')
placebo.distribution.cohens.d<-data.frame(read_dta(nullFilePath))
#########################################################################################################
# Trim placebo distribution
placebo.distribution.trim <- placebo.distribution.full[,placebo.distribution.cohens.d<=CohensDThreshold]
# Random sample
SAMPLE <- sample(SCUL.input$x.DonorPool, 100)
# Make a wide column that includes time
data_to_plot_wide <- cbind( temp.time, SCUL.input$x.DonorPool)
data_to_plot_long <- melt(data_to_plot_wide, id.vars = c("time"))
names(data_to_plot_long) <- c("time", "group", "value")
head(data_to_plot_long)
y_vars <- data.frame(temp.time,
processed.AllYData$CO_all_beer_total_oz,
processed.AllYData$CO_liquor_total_oz,
processed.AllYData$CO_wine_total_oz,
processed.AllYData$CO_pain_pill_total_cnt
)
names(y_vars) <- c("time", "beer", "liquor", "wine", "pills")
temp_max <- data.frame(aggregate(data_to_plot_long$value, by = list(data_to_plot_long$time), max))
names(temp_max) <- c("time", "max_value")
temp_min <- data.frame(aggregate(data_to_plot_long$value, by = list(data_to_plot_long$time), min))
names(temp_min) <- c("time", "min_value")
SAMPLE.data_to_plot_wide <- cbind( temp.time, SAMPLE)
SAMPLE.data_to_plot_long <- melt(SAMPLE.data_to_plot_wide, id.vars = c("time"))
names(SAMPLE.data_to_plot_long) <- c("time", "group", "value")
head(SAMPLE.data_to_plot_long)
test <- ggplot(data = SAMPLE.data_to_plot_long, aes(x = time, y = value)) +
geom_line(aes(group = group), alpha = .25, size = 1) +
theme_classic() +
+
geom_segment(
aes(
x = (as.Date("2012-11-03")),
xend = (as.Date("2012-11-03")),
y = -5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
) +
geom_segment(
aes(
x = (as.Date("2014-01-01")),
xend = (as.Date("2014-01-01")),
y = -5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
)   +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.00, color = '#ffab10') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.00, color = '#4dac26') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.00, color = 'red') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.00, color = 'blue') +
geom_line(data = temp_max, aes(x = time, y = max_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
geom_line(data = temp_min, aes(x = time, y = min_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
labs(
title = "Natural log of quatity sold of four target products in Colorado\n compared to the time series of a sample from donor pool",
x = "Time",
y = "Natural log of weekly quantity sold"
) +
theme(
axis.text = element_text(size = 18),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
annotate("text", y =4  , x=(as.Date("2014-01-01")),
label= "Min. donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", y =20.75  , x=(as.Date("2007-01-01")),
label= "Max donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", x = as.Date("2012-11-03"), y = 21, label = "Possesion legal", size = 4, hjust = 0.75) +
annotate("text", x = as.Date("2014-01-01"), y = 21, label = "Selling legal", size = 4, hjust = 0.25)
annotation <- data.frame(
x = c(as.Date("2010-01-01"), as.Date("2009-01-01"), as.Date("2013-01-01"), as.Date("2014-01-01")),
y = c(11.25, 14.5, 15, 17),
label = c("Hard liquor", "Wine", "Beer", "Pain pills")
)
test <-    test +
geom_label(data = annotation, aes(y =y  , x=x, label= label),
size = 4, color = "black")
test
ggsave("~/Documents/GitHub/scul_work/vignettes/time_series_raw_data.png",
plot = test,
dpi = 300,
width = 9,
height = 6,
units = "in")
test <- ggplot(data = SAMPLE.data_to_plot_long, aes(x = time, y = value)) +
geom_line(aes(group = group), alpha = .25, size = 1) +
theme_classic() +
geom_segment(
aes(
x = (as.Date("2012-11-03")),
xend = (as.Date("2012-11-03")),
y = -5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
) +
geom_segment(
aes(
x = (as.Date("2014-01-01")),
xend = (as.Date("2014-01-01")),
y = -5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
)   +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.00, color = '#ffab10') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.00, color = '#4dac26') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.00, color = 'red') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.00, color = 'blue') +
geom_line(data = temp_max, aes(x = time, y = max_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
geom_line(data = temp_min, aes(x = time, y = min_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
labs(
title = "Natural log of quatity sold of four target products in Colorado\n compared to the time series of a sample from donor pool",
x = "Time",
y = "Natural log of weekly quantity sold"
) +
theme(
axis.text = element_text(size = 18),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
annotate("text", y =4  , x=(as.Date("2014-01-01")),
label= "Min. donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", y =20.75  , x=(as.Date("2007-01-01")),
label= "Max donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", x = as.Date("2012-11-03"), y = 21, label = "Possesion legal", size = 4, hjust = 0.75) +
annotate("text", x = as.Date("2014-01-01"), y = 21, label = "Selling legal", size = 4, hjust = 0.25)
annotation <- data.frame(
x = c(as.Date("2010-01-01"), as.Date("2009-01-01"), as.Date("2013-01-01"), as.Date("2014-01-01")),
y = c(11.25, 14.5, 15, 17),
label = c("Hard liquor", "Wine", "Beer", "Pain pills")
)
test <-    test +
geom_label(data = annotation, aes(y =y  , x=x, label= label),
size = 4, color = "black")
test
ggsave("~/Documents/GitHub/scul_work/vignettes/time_series_raw_data.png",
plot = test,
dpi = 300,
width = 9,
height = 6,
units = "in")
min(temp_min)
temp_min
min(temp_min$min_value)
test <- ggplot(data = SAMPLE.data_to_plot_long, aes(x = time, y = value)) +
geom_line(aes(group = group), alpha = .25, size = 1) +
theme_classic() +
geom_segment(
aes(
x = (as.Date("2012-11-03")),
xend = (as.Date("2012-11-03")),
y = 2.5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
) +
geom_segment(
aes(
x = (as.Date("2014-01-01")),
xend = (as.Date("2014-01-01")),
y = 2.5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
)   +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.00, color = '#ffab10') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.00, color = '#4dac26') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.00, color = 'red') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.00, color = 'blue') +
geom_line(data = temp_max, aes(x = time, y = max_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
geom_line(data = temp_min, aes(x = time, y = min_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
labs(
title = "Natural log of quatity sold of four target products in Colorado\n compared to the time series of a sample from donor pool",
x = "Time",
y = "Natural log of weekly quantity sold"
) +
theme(
axis.text = element_text(size = 18),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
annotate("text", y =4  , x=(as.Date("2014-01-01")),
label= "Min. donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", y =20.75  , x=(as.Date("2007-01-01")),
label= "Max donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", x = as.Date("2012-11-03"), y = 21, label = "Possesion legal", size = 4, hjust = 0.75) +
annotate("text", x = as.Date("2014-01-01"), y = 21, label = "Selling legal", size = 4, hjust = 0.25)
annotation <- data.frame(
x = c(as.Date("2010-01-01"), as.Date("2009-01-01"), as.Date("2013-01-01"), as.Date("2014-01-01")),
y = c(11.25, 14.5, 15, 17),
label = c("Hard liquor", "Wine", "Beer", "Pain pills")
)
test <-    test +
geom_label(data = annotation, aes(y =y  , x=x, label= label),
size = 4, color = "black")
test
ggsave("~/Documents/GitHub/scul_work/vignettes/time_series_raw_data.png",
plot = test,
dpi = 300,
width = 9,
height = 6,
units = "in")
test <- ggplot(data = SAMPLE.data_to_plot_long, aes(x = time, y = value)) +
geom_line(aes(group = group), alpha = .25, size = 1) +
theme_classic() +
geom_segment(
aes(
x = (as.Date("2012-11-03")),
xend = (as.Date("2012-11-03")),
y = 2.5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
) +
geom_segment(
aes(
x = (as.Date("2014-01-01")),
xend = (as.Date("2014-01-01")),
y = 2.5,
yend = 20.5),
linetype = "dashed",
size = 1,
color = "grey37"
)   +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = beer), alpha = 1 , size = 1.00, color = '#ffab10') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = liquor), alpha = 1 , size = 1.00, color = '#4dac26') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = wine), alpha = 1 , size = 1.00, color = 'red') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.25, color = 'black') +
geom_line(data = y_vars, aes(x = time, y = pills), alpha = 1 , size = 1.00, color = 'blue') +
geom_line(data = temp_max, aes(x = time, y = max_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
geom_line(data = temp_min, aes(x = time, y = min_value), alpha = 1 , size = .50, color = 'black', linetype = "solid") +
labs(
title = "Natural log of quatity sold of four target products in Colorado\n compared to the time series of a sample from donor pool",
x = "Time",
y = "Natural log of weekly quantity sold"
) +
theme(
axis.text = element_text(size = 18),
axis.title = element_text(size = 18),
title = element_text(size = 16),
legend.position = "none"
) +
annotate("text", y =4.25  , x=(as.Date("2014-06-01")),
label= "Min. donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", y =20.75  , x=(as.Date("2007-01-01")),
label= "Max donor value",
hjust = 0,  size = 4, color = "black") +
annotate("text", x = as.Date("2012-11-03"), y = 21, label = "Possesion legal", size = 4, hjust = 0.75) +
annotate("text", x = as.Date("2014-01-01"), y = 21, label = "Selling legal", size = 4, hjust = 0.25)
annotation <- data.frame(
x = c(as.Date("2010-01-01"), as.Date("2009-01-01"), as.Date("2013-01-01"), as.Date("2014-01-01")),
y = c(11.25, 14.5, 15, 17),
label = c("Hard liquor", "Wine", "Beer", "Pain pills")
)
test <-    test +
geom_label(data = annotation, aes(y =y  , x=x, label= label),
size = 4, color = "black")
test
ggsave("~/Documents/GitHub/scul_work/vignettes/time_series_raw_data.png",
plot = test,
dpi = 300,
width = 9,
height = 6,
units = "in")
